
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>Output2 Generator</title>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #edf7e1;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #145A32;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        select, input[type="file"], button {
            margin-top: 5px;
            width: 100%;
            padding: 10px;
            font-size: 14px;
        }
        .multi-select {
            height: 120px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        #progress {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Output2 Generator</h1>
    <div>Version: 2025-06-26 20:15 (All UI restored)</div>

    <label for="fileInput">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Raw Data (.xlsx):</label>
    <input type="file" id="fileInput" accept=".xlsx" />

    <button class="btn" onclick="uploadFile()">üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
    <div id="progress"></div>

    <label for="months">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
    <select id="months" multiple class="multi-select"></select>

    <label for="category2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</label>
    <select id="category2" multiple class="multi-select"></select>
    <button onclick="addAll('category2')">Add All</button>

    <label for="category3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</label>
    <select id="category3" multiple class="multi-select"></select>
    <button onclick="addAll('category3')">Add All</button>

    <label for="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
    <select id="status" multiple class="multi-select"></select>

    <label for="processStatus">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Process:</label>
    <select id="processStatus" multiple class="multi-select"></select>

    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
    <label><input type="radio" name="top5" value="true" checked /> ‡πÅ‡∏™‡∏î‡∏á Top 5</label>
    <label><input type="radio" name="top5" value="false" /> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>

    <button class="btn" onclick="generateOutput2()">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2</button>

    <script>
        function addAll(selectId) {
            const select = document.getElementById(selectId);
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }

        function uploadFile() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå");

            const formData = new FormData();
            formData.append("file", file);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "https://output2-generator-production.up.railway.app/upload_raw_data", true);

            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    document.getElementById("progress").textContent = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: " + percent + "%";
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    loadDropdowns();
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
                }
            };
            xhr.onerror = function () {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
            };

            xhr.send(formData);
        }

        function loadDropdowns() {
            fetch("https://output2-generator-production.up.railway.app/extract_months_categories", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => {
                populateSelect("months", data.months);
                populateSelect("category2", data.category2);
                populateSelect("category3", data.category3);
                populateSelect("status", data.status);
                populateSelect("processStatus", data.processStatus);
            })
            .catch(err => {
                console.error(err);
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
            });
        }

        function populateSelect(id, values) {
            const select = document.getElementById(id);
            select.innerHTML = "";
            values.forEach(v => {
                const option = document.createElement("option");
                option.value = v;
                option.text = v;
                select.add(option);
            });
        }

        function generateOutput2() {
            const months = getSelectedValues("months");
            const cat2 = getSelectedValues("category2");
            const cat3 = getSelectedValues("category3");
            const stat = getSelectedValues("status");
            const proc = getSelectedValues("processStatus");
            const top5 = document.querySelector('input[name="top5"]:checked').value === "true";

            const payload = {
                months,
                category2: cat2,
                category3: cat3,
                status: stat,
                processStatus: proc,
                showTop5: top5
            };

            fetch("https://output2-generator-production.up.railway.app/generate_output2", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error("Download failed");
                return res.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Output2.xlsx";
                a.click();
                URL.revokeObjectURL(url);
            })
            .catch(err => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ"));
        }

        function getSelectedValues(id) {
            const options = document.getElementById(id).selectedOptions;
            return Array.from(options).map(o => o.value);
        }
    </script>
</body>
</html>
