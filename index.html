<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Output2 Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #e0f7e9;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1 { color: #1b5e20; }
    label { font-weight: bold; margin-top: 15px; display: block; }
    select, input[type="file"], button { width: 100%; padding: 8px; margin-top: 5px; }
    .select2-container { width: 100% !important; }
    .flex-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .column { flex: 1; min-width: 200px; }
    .version { text-align: right; color: gray; font-size: 0.85em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Output2 Generator</h1>
  <div class="version">Version: 2025-06-26 18:35:44</div>

  <label>ğŸ“¤ Upload Raw Data (.xlsx)</label>
  <input type="file" id="rawFile" accept=".xlsx" />
  <button onclick="uploadFile()">Upload</button>
  <progress id="uploadProgress" value="0" max="100" style="width:100%; display:none;"></progress>

  <div class="flex-row">
    <div class="column">
      <label>ğŸ“… à¹€à¸¥à¸·à¸­à¸à¹€à¸”à¸·à¸­à¸™:</label>
      <select id="months" multiple class="select2"></select>
    </div>
    <div class="column">
      <label>ğŸ“ à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ2: <button onclick="selectAll('category2')">Add All</button></label>
      <select id="category2" multiple class="select2"></select>
    </div>
    <div class="column">
      <label>ğŸ“‚ à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ3: <button onclick="selectAll('category3')">Add All</button></label>
      <select id="category3" multiple class="select2"></select>
    </div>
  </div>

  <div class="flex-row">
    <div class="column">
      <label>ğŸ“Œ à¸ªà¸–à¸²à¸™à¸°:</label>
      <select id="status" multiple class="select2"></select>
    </div>
    <div class="column">
      <label>âš™ï¸ à¸ªà¸–à¸²à¸™à¸° Process:</label>
      <select id="processStatus" multiple class="select2"></select>
    </div>
  </div>

  <div style="margin: 15px 0;">
    <label><input type="radio" name="mode" value="top5" checked /> Top 5</label>
    <label><input type="radio" name="mode" value="all" /> à¹à¸ªà¸”à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</label>
  </div>

  <button onclick="downloadOutput()">ğŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸” Output2</button>
  <div id="errorMsg" style="color:red;"></div>
  <div id="successMsg" style="color:green;"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    function initializeSelect2() {
      $('.select2').select2({ placeholder: "à¹€à¸¥à¸·à¸­à¸à¹„à¸”à¹‰à¸«à¸¥à¸²à¸¢à¸£à¸²à¸¢à¸à¸²à¸£", allowClear: true });
    }

    function uploadFile() {
      const file = document.getElementById("rawFile").files[0];
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const progressBar = document.getElementById("uploadProgress");
      errorMsg.textContent = "";
      successMsg.textContent = "";
      if (!file) {
        errorMsg.textContent = "à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸à¹ˆà¸­à¸™";
        return;
      }
      const formData = new FormData();
      formData.append("rawFile", file);

      progressBar.style.display = "block";

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "https://output2-generator-production.up.railway.app/upload_raw_data", true);
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          progressBar.value = (e.loaded / e.total) * 100;
        }
      };
      xhr.onload = () => {
        progressBar.style.display = "none";
        if (xhr.status === 200) {
          try {
            const res = JSON.parse(xhr.responseText);
            if (Array.isArray(res.months)) populate("months", res.months);
            if (Array.isArray(res.category2)) populate("category2", res.category2);
            if (Array.isArray(res.category3)) populate("category3", res.category3);
            if (Array.isArray(res.status)) populate("status", res.status);
            if (Array.isArray(res.processStatus)) populate("processStatus", res.processStatus);
            successMsg.textContent = "âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ";
          } catch (err) {
            errorMsg.textContent = "âŒ Response format à¸œà¸´à¸”";
          }
        } else {
          errorMsg.textContent = "âŒ à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§: " + xhr.statusText;
        }
      };
      xhr.send(formData);
    }

    function populate(id, list) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      list.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        select.appendChild(opt);
      });
      $(`#$<built-in function id>`).trigger("change");
    }

    function selectAll(id) {
      const select = document.getElementById(id);
      const values = Array.from(select.options).map(o => o.value);
      $(`#$<built-in function id>`).val(values).trigger("change");
    }

    async function downloadOutput() {
      const formData = new FormData();
      ["months", "category2", "category3", "status", "processStatus"].forEach(id => {
        const val = $(`#$<built-in function id>`).val();
        if (val) val.forEach(v => formData.append(id, v));
      });
      formData.append("mode", document.querySelector("input[name='mode']:checked").value);

      try {
        const res = await fetch("https://output2-generator-production.up.railway.app/generate_output2", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¹„à¸”à¹‰");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Output2.xlsx";
        a.click();
      } catch (err) {
        document.getElementById("errorMsg").textContent = err.message;
      }
    }

    $(document).ready(initializeSelect2);
  </script>
</body>
</html>
