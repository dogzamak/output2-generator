<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Output2 Generator</title>
    <style>
        body {
            font-family: sans-serif;
            background: #eff8ef;
            padding: 20px;
        }
        h1 {
            color: #004d00;
        }
        .section {
            margin-bottom: 15px;
        }
        textarea, select {
            width: 100%;
            min-height: 80px;
            font-size: 1em;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            font-size: 1em;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Output2 Generator</h1>
    <div><strong>Version:</strong> 2025-06-26 23.38 (CORS verified)</div>
    <div class="section">
        <label><strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Raw Data (.xlsx):</strong></label><br>
        <input type="file" id="rawFileInput">
        <button onclick="uploadFile()">üì• ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
        <div id="uploadStatus"></div>
    </div>

    <div class="section">
        <label><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong></label><br>
        <select id="monthSelect" multiple></select>
    </div>
    <div class="section">
        <label><strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</strong></label><br>
        <select id="cat2Select" multiple></select>
    </div>
    <div class="section">
        <label><strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</strong></label><br>
        <select id="cat3Select" multiple></select>
    </div>
    <div class="section">
        <label><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong></label><br>
        <select id="statusSelect" multiple></select>
    </div>
    <div class="section">
        <label><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Process:</strong></label><br>
        <select id="processStatusSelect" multiple></select>
    </div>

    <div class="section">
        <label><input type="checkbox" id="top5Checkbox"> ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Top 5</label>
    </div>

    <div class="section">
        <button onclick="generateOutput2()">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2</button>
    </div>

    <script>
        const apiBase = "https://output2-generator-production.up.railway.app";

        function uploadFile() {
            const fileInput = document.getElementById("rawFileInput");
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append("file", file);
            fetch(`${apiBase}/upload_raw_data`, {
                method: "POST",
                body: formData,
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById("uploadStatus").innerText = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: 100%";
                populateSelect("monthSelect", data.months);
                populateSelect("cat2Select", data.category2);
                populateSelect("cat3Select", data.category3);
                populateSelect("statusSelect", data.status);
                populateSelect("processStatusSelect", data.processStatus);
            })
            .catch(err => {
                console.error("Upload error", err);
                alert("Upload failed");
            });
        }

        function populateSelect(id, values) {
            const sel = document.getElementById(id);
            sel.innerHTML = "";
            values.forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                opt.innerText = val;
                sel.appendChild(opt);
            });
        }

        function generateOutput2() {
            const months = getSelectValues("monthSelect");
            const cat2 = getSelectValues("cat2Select");
            const cat3 = getSelectValues("cat3Select");
            const status = getSelectValues("statusSelect");
            const process = getSelectValues("processStatusSelect");
            const top5 = document.getElementById("top5Checkbox").checked;

            const payload = {
                months,
                category2: cat2,
                category3: cat3,
                status,
                process_status: process,
                top5
            };

            fetch(`${apiBase}/generate_output2`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Output2.xlsx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(err => {
                console.error("Output2 error", err);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Output2 ‡πÑ‡∏î‡πâ");
            });
        }

        function getSelectValues(id) {
            const sel = document.getElementById(id);
            return Array.from(sel.selectedOptions).map(opt => opt.value);
        }
    </script>
</body>
</html>
