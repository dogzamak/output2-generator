
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Output2 Generator</title>
</head>
<body>
  <h2>อัปโหลดไฟล์ Excel (Raw Data)</h2>
  <input type="file" id="fileInput" accept=".xlsx" />
  <div id="filters" style="margin-top: 20px;"></div>
  <div id="actions" style="margin-top: 20px; display:none;">
    <label><input type="radio" name="filterType" value="top5" checked> แสดงเฉพาะ Top 5</label>
    <label><input type="radio" name="filterType" value="all"> แสดงทั้งหมด</label>
    <br><br>
    <button onclick="generateOutput2()">Generate Output2</button>
  </div>
  <script>
    let rawFile;
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      rawFile = e.target.files[0];
      const formData = new FormData();
      formData.append('rawFile', rawFile);
      const res = await fetch('https://ptg-output2-web.onrender.com/extract_months_categories', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      const filters = document.getElementById('filters');
      filters.innerHTML = '';

      filters.innerHTML += '<h3>เลือกเดือน:</h3>';
      data.months.forEach(m => {
        filters.innerHTML += `<label><input type="checkbox" name="months" value="${m}"> ${m}</label><br>`;
      });

      filters.innerHTML += '<h3>หมวดหมู่2:</h3>';
      filters.innerHTML += '<select id="category2" multiple>' +
        data.category2.map(c => `<option value="${c}">${c}</option>`).join('') +
        '</select>';

      filters.innerHTML += '<h3>หมวดหมู่3:</h3>';
      filters.innerHTML += '<select id="category3" multiple>' +
        data.category3.map(c => `<option value="${c}">${c}</option>`).join('') +
        '</select>';

      document.getElementById('actions').style.display = 'block';
    });

    async function generateOutput2() {
      const months = [...document.querySelectorAll('input[name="months"]:checked')].map(e => e.value);
      const category2 = [...document.getElementById('category2').selectedOptions].map(o => o.value);
      const category3 = [...document.getElementById('category3').selectedOptions].map(o => o.value);
      const filterType = document.querySelector('input[name="filterType"]:checked').value;

      const formData = new FormData();
      formData.append('rawFile', rawFile);
      months.forEach(m => formData.append('months[]', m));
      category2.forEach(c => formData.append('category2[]', c));
      category3.forEach(c => formData.append('category3[]', c));
      formData.append('filterType', filterType);

      const res = await fetch('https://ptg-output2-web.onrender.com/generate_output2', {
        method: 'POST',
        body: formData
      });

      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = "Output2.xlsx";
      link.click();
    }
  </script>
</body>
</html>
