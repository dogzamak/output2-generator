
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Output2 Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            background-color: #e9f5e9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 960px;
            margin: auto;
        }
        h1 {
            color: #006400;
            margin-bottom: 20px;
        }
        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        select {
            width: 100%;
        }
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ccc;
            min-height: 40px;
            background: white;
            border-radius: 6px;
            padding: 6px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            padding: 2px 8px;
            margin-top: 5px;
            font-size: 14px;
            margin-right: 5px;
        }
        .select2-selection__choice__remove {
            color: #ffffff !important;
            margin-left: 5px;
            font-weight: bold;
        }
        .select2-selection__choice__remove:hover {
            color: #ffcdd2 !important;
        }
        .button-group {
            margin-top: 20px;
        }
        .progress-bar {
            height: 20px;
            background-color: #4caf50;
            color: white;
            text-align: center;
            width: 0%;
        }
        .progress-container {
            width: 100%;
            background-color: #ccc;
            margin-top: 10px;
            display: none;
        }
        .status-message {
            margin-top: 10px;
            font-weight: bold;
            color: red;
        }
        button, input[type="file"] {
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .btn {
            background-color: #388e3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #2e7d32;
        }
    </style>
</head>
<body>
    <h1>Output2 Generator</h1>
    <label for="fileInput">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Raw Data (.xlsx):</label>
    <input type="file" id="fileInput" accept=".xlsx">
    <button class="btn" onclick="uploadFile()">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    <div class="progress-container"><div class="progress-bar" id="uploadProgress"></div></div>
    <div class="status-message" id="statusMsg"></div>

    <label for="months">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
    <select id="months" multiple="multiple"></select>

    <label for="category2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</label>
    <select id="category2" multiple="multiple"></select>
    <button class="btn" onclick="addAll('category2')">Add All</button>

    <label for="category3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</label>
    <select id="category3" multiple="multiple"></select>
    <button class="btn" onclick="addAll('category3')">Add All</button>

    <label for="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
    <select id="status" multiple="multiple"></select>

    <label for="statusProcess">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Process:</label>
    <select id="statusProcess" multiple="multiple"></select>

    <label>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</label>
    <input type="radio" name="topOption" value="top5" checked> Top 5
    <input type="radio" name="topOption" value="all"> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    <div class="button-group">
        <button class="btn" onclick="downloadOutput2()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2</button>
    </div>

    <script>
        const backendUrl = "https://output2-generator-production.up.railway.app";

        function addAll(selectId) {
            const options = $(`#${selectId} option`).map(function() { return this.value; }).get();
            $(`#${selectId}`).val(options).trigger('change');
        }

        function loadDropdowns(data) {
            const { months, category2, category3, status, status_process } = data;
            const sets = {
                months: months || [],
                category2: category2 || [],
                category3: category3 || [],
                status: status || [],
                statusProcess: status_process || []
            };
            Object.keys(sets).forEach(key => {
                const el = $(`#${key}`);
                el.empty();
                if (Array.isArray(sets[key])) {
                    sets[key].forEach(item => el.append(new Option(item, item)));
                }
                el.trigger('change');
            });
        }

        $(document).ready(function() {
            $("#months, #category2, #category3, #status, #statusProcess").select2();
        });

        function uploadFile() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            $(".progress-container").show();
            $("#uploadProgress").css("width", "0%").text("0%");
            $("#statusMsg").text("");

            $.ajax({
                url: backendUrl + "/upload_raw_data",
                method: "POST",
                data: formData,
                contentType: false,
                processData: false,
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            const percent = Math.round((evt.loaded / evt.total) * 100);
                            $("#uploadProgress").css("width", percent + "%").text(percent + "%");
                        }
                    }, false);
                    return xhr;
                },
                success: function(response) {
                    if (response && typeof response === "object") {
                        loadDropdowns(response);
                    } else {
                        $("#statusMsg").text("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å backend");
                    }
                },
                error: function() {
                    $("#statusMsg").text("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend ‡πÑ‡∏î‡πâ");
                }
            });
        }

        function downloadOutput2() {
            const payload = {
                months: $("#months").val(),
                category2: $("#category2").val(),
                category3: $("#category3").val(),
                status: $("#status").val(),
                status_process: $("#statusProcess").val(),
                top: $("input[name='topOption']:checked").val()
            };

            fetch(backendUrl + "/generate_output2", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error("Download failed");
                return res.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "Output2.xlsx";
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(() => alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Output2.xlsx ‡πÑ‡∏î‡πâ"));
        }
    </script>
</body>
</html>
