
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Output2 Generator</title>
  <link rel="icon" href="data:,">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container mt-4" style="max-width: 720px">
    <h2 class="text-center mb-4">üìä Output2 Generator</h2>
    <div class="mb-3">
      <label class="form-label fw-bold">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
      <input type="file" class="form-control" id="fileInput" accept=".xlsx">
      <button class="btn btn-primary mt-2" onclick="handleUpload()">Upload & Load Filters</button>
    </div>
    <div id="filters" style="display:none">
      <div class="mb-2">
        <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)</label>
        <select class="form-select" multiple id="monthSelect"></select>
      </div>
      <div class="mb-2">
        <label class="form-label fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2</label>
        <select class="form-select" multiple id="cat2Select"></select>
      </div>
      <div class="mb-2">
        <label class="form-label fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3</label>
        <select class="form-select" multiple id="cat3Select"></select>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
        <div>
          <input type="radio" name="filterType" value="top5" checked> ‡πÅ‡∏™‡∏î‡∏á Top 5
          <input type="radio" name="filterType" value="all" class="ms-3"> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </div>
      </div>
      <button class="btn btn-success" onclick="generateOutput2()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    let rawFile = null;
    async function handleUpload() {
      const fileInput = document.getElementById("fileInput");
      rawFile = fileInput.files[0];
      if (!rawFile) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }
      const formData = new FormData();
      formData.append("rawFile", rawFile);
      const res = await fetch("https://output2-generator-production.up.railway.app/extract_months_categories", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      loadOptions("monthSelect", data.months);
      loadOptions("cat2Select", data.category2);
      loadOptions("cat3Select", data.category3);
      document.getElementById("filters").style.display = "block";
      $(".form-select").select2({ width: '100%' });
    }

    function loadOptions(id, values) {
      const el = document.getElementById(id);
      el.innerHTML = "";
      values.forEach(val => {
        const option = document.createElement("option");
        option.value = val;
        option.textContent = val;
        el.appendChild(option);
      });
    }

    async function generateOutput2() {
      const formData = new FormData();
      formData.append("rawFile", rawFile);
      const months = $('#monthSelect').val();
      const cat2 = $('#cat2Select').val();
      const cat3 = $('#cat3Select').val();
      const type = document.querySelector('input[name="filterType"]:checked').value;
      months.forEach(m => formData.append("months[]", m));
      cat2.forEach(c => formData.append("category2[]", c));
      cat3.forEach(c => formData.append("category3[]", c));
      formData.append("filterType", type);

      const res = await fetch("https://output2-generator-production.up.railway.app/generate_output2", {
        method: "POST",
        body: formData
      });
      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = "Output2.xlsx";
      link.click();
    }
  </script>
</body>
</html>
