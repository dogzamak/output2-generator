<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Output2 Generator</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    label { display: block; margin-top: 1rem; }
    .select2 { width: 100% !important; }
  </style>
</head>
<body>
  <h2>Output2 Generator</h2>
  <label>Upload Raw Data (.xlsx):</label>
  <input type="file" id="rawFile" accept=".xlsx" />

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + ‡∏õ‡∏µ:</label>
  <div id="monthsContainer"></div>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</label>
  <select id="category2" multiple></select>

  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</label>
  <select id="category3" multiple></select>

  <label>‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</label>
  <input type="radio" name="filterType" value="top5" checked /> Top 5 Grand Total
  <input type="radio" name="filterType" value="all" /> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

  <br /><br />
  <button onclick="generateOutput()">Generate Output2</button>
  <div id="downloadLink"></div>

<script>
  let months = [];

  $("#category2, #category3").select2({ placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" });

  $("#rawFile").on("change", function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("rawFile", file);

    $.post({
      url: "/extract_months_categories",
      data: formData,
      processData: false,
      contentType: false,
      success: function (res) {
        months = res.months;
        $("#monthsContainer").empty();
        months.forEach(m => {
          const id = "month_" + m.replace(/\s/g, '_');
          $("#monthsContainer").append(
            `<label><input type='checkbox' name='months' value='${m}' id='${id}' checked /> ${m}</label>`
          );
        });

        $("#category2").empty();
        res.category2.forEach(c => {
          $("#category2").append(`<option value="${c}">${c}</option>`);
        });

        $("#category3").empty();
        res.category3.forEach(c => {
          $("#category3").append(`<option value="${c}">${c}</option>`);
        });

        $("#category2").trigger("change");
        $("#category3").trigger("change");
      }
    });
  });

  function generateOutput() {
    const file = $("#rawFile")[0].files[0];
    if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Raw Data");

    const formData = new FormData();
    formData.append("rawFile", file);
    $("input[name='months']:checked").each(function () {
      formData.append("months[]", $(this).val());
    });
    $("#category2").val().forEach(v => formData.append("category2[]", v));
    $("#category3").val().forEach(v => formData.append("category3[]", v));

    const filterType = $("input[name='filterType']:checked").val();
    formData.append("filterType", filterType);

    fetch("/generate_output2", {
      method: "POST",
      body: formData
    })
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Output2.xlsx";
        document.getElementById("downloadLink").innerHTML = "";
        document.getElementById("downloadLink").appendChild(a);
        a.textContent = "üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2.xlsx";
      });
  }
</script>
</body>
</html>
