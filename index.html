
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Output2 Generator</title>
  <style>
    body {
      background-color: #e6ffe6; /* เขียวอ่อนแบบสดใส */
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      color: #1b5e20;
    }
    label {
      font-weight: bold;
    }
    select, input[type="file"], button {
      margin-top: 5px;
      margin-bottom: 15px;
      padding: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <h1>Output2 Generator</h1>
  <form id="uploadForm">
    <label>อัปโหลดไฟล์ Excel (.xlsx)</label><br />
    <input type="file" name="rawFile" id="rawFile" required /><br />

    <label>เลือกหมวดหมู่ 2:</label><br />
    <select multiple id="category2"></select>
    <button type="button" onclick="addAll('category2')">Add All</button><br />

    <label>เลือกหมวดหมู่ 3:</label><br />
    <select multiple id="category3"></select>
    <button type="button" onclick="addAll('category3')">Add All</button><br />

    <label>เลือกเดือน:</label><br />
    <select multiple id="months"></select><br />

    <button type="submit">ดาวน์โหลด Output2</button>
  </form>

  <script>
    const backendBaseURL = "https://output2-generator-production.up.railway.app";

    document.getElementById("rawFile").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("rawFile", file);

      try {
        const res = await fetch(`${backendBaseURL}/extract_months_categories`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        populateSelect("category2", data.category2);
        populateSelect("category3", data.category3);
        populateSelect("months", data.months);
      } catch (err) {
        alert("❌ เกิดข้อผิดพลาด: " + err.message);
      }
    });

    function populateSelect(id, values) {
      const select = document.getElementById(id);
      select.innerHTML = "";
      values.forEach(val => {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        select.appendChild(opt);
      });
    }

    function addAll(selectId) {
      const select = document.getElementById(selectId);
      for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = true;
      }
    }

    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const file = document.getElementById("rawFile").files[0];
      if (!file) return alert("กรุณาเลือกไฟล์");

      const formData = new FormData();
      formData.append("rawFile", file);
      formData.append("category2", getSelectedValues("category2"));
      formData.append("category3", getSelectedValues("category3"));
      formData.append("months", getSelectedValues("months"));

      try {
        const res = await fetch(`${backendBaseURL}/generate_output2`, {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("ไม่สามารถดาวน์โหลดไฟล์ได้");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Output2.xlsx";
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert("❌ ไม่สามารถดาวน์โหลดไฟล์ได้

" + err.message);
      }
    });

    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(opt => opt.value);
    }
  </script>
</body>
</html>
