
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Output2 Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f8f9fa; padding-top: 50px; }
    .container { max-width: 800px; }
    .select2-container { width: 100% !important; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">üìä Output2 Generator</h2>
    <div class="mb-3">
      <label for="fileInput" class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</label>
      
    <input type="file" class="form-control mb-2" id="fileInput" accept=".xlsx" />
    <button class="btn btn-secondary" onclick="handleUpload()">Upload</button>
    
    </div>

    <div id="filters" class="mb-4"></div>

    <div id="actions" class="text-center" style="display:none;">
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="filterType" value="top5" checked>
        <label class="form-check-label">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Top 5</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="filterType" value="all">
        <label class="form-check-label">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
      </div>
      <br><br>
      <button class="btn btn-primary" onclick="generateOutput2()">Generate Output2</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    let rawFile;
    async function handleUpload() { const e = document.getElementById('fileInput'); rawFile = e.files[0]; if (!rawFile) return;
      rawFile = e.target.files[0];
      const formData = new FormData();
      formData.append('rawFile', rawFile);
      const res = await fetch('https://ptg-output2-web.onrender.com/extract_months_categories', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      const filters = document.getElementById('filters');
      filters.innerHTML = '';

      filters.innerHTML += '<h5>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</h5>';
      data.months.forEach(m => {
        filters.innerHTML += `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="months" value="${m}">
            <label class="form-check-label">${m}</label>
          </div>`;
      });

      filters.innerHTML += '<h5 class="mt-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</h5>';
      filters.innerHTML += '<select id="category2" class="form-select" multiple></select>';
      filters.innerHTML += '<h5 class="mt-3">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</h5>';
      filters.innerHTML += '<select id="category3" class="form-select" multiple></select>';

      data.category2.forEach(c => {
        const option = new Option(c, c, false, false);
        document.getElementById('category2').appendChild(option);
      });

      data.category3.forEach(c => {
        const option = new Option(c, c, false, false);
        document.getElementById('category3').appendChild(option);
      });

      setTimeout(() => {
        $('#category2').select2({ placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2" });
        $('#category3').select2({ placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3" });
      }, 100);

      document.getElementById('actions').style.display = 'block';
    });

    async function generateOutput2() {
      const months = [...document.querySelectorAll('input[name="months"]:checked')].map(e => e.value);
      const category2 = [...document.getElementById('category2').selectedOptions].map(o => o.value);
      const category3 = [...document.getElementById('category3').selectedOptions].map(o => o.value);
      const filterType = document.querySelector('input[name="filterType"]:checked').value;

      const formData = new FormData();
      formData.append('rawFile', rawFile);
      months.forEach(m => formData.append('months[]', m));
      category2.forEach(c => formData.append('category2[]', c));
      category3.forEach(c => formData.append('category3[]', c));
      formData.append('filterType', filterType);

      const res = await fetch('https://ptg-output2-web.onrender.com/generate_output2', {
        method: 'POST',
        body: formData
      });

      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = "Output2.xlsx";
      link.click();
    }
  </script>
</body>
</html>
