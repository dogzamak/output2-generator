
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Output2 Generator</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      background-color: #e6f4ea;
      font-family: sans-serif;
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }
    label { font-weight: bold; margin-top: 1rem; display: block; }
    select { width: 100%; }
    button, input[type="file"] {
      margin-top: 1rem;
    }
    .progress-bar {
      margin-top: 1rem;
      width: 100%;
      height: 20px;
      background-color: #d3d3d3;
    }
    .progress {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
    }
  </style>
</head>
<body>
  <h2>Output2 Generator</h2>
  <p id="version"></p>

  <label for="fileInput">Upload Raw Data (.xlsx):</label>
  <input type="file" id="fileInput" accept=".xlsx" />
  <div class="progress-bar"><div class="progress" id="uploadProgress"></div></div>
  <button onclick="uploadFile()">Upload</button>

  <div id="filters" style="display:none;">
    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
    <select id="months" multiple></select>

    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà2:</label>
    <select id="category2" multiple></select>
    <button onclick="selectAll('category2')">Add All</button>

    <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà3:</label>
    <select id="category3" multiple></select>
    <button onclick="selectAll('category3')">Add All</button>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
    <select id="status" multiple></select>

    <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Process:</label>
    <select id="processStatus" multiple></select>

    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</label><br />
    <input type="radio" name="top5Option" value="true" checked /> Top 5 <br />
    <input type="radio" name="top5Option" value="false" /> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <br />

    <button onclick="generateOutput2()">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Output2</button>
  </div>

  <script>
    const backendURL = "https://output2-generator-production.up.railway.app";

    document.getElementById("version").innerText = "Version: " + new Date().toLocaleString();

    function selectAll(id) {
      const $el = $(`#${id}`);
      const values = [];
      $el.find("option").each(function () {
        values.push($(this).val());
      });
      $el.val(values).trigger("change");
    }

    function populate(id, items) {
      const $select = $(`#${id}`);
      $select.empty();
      if (Array.isArray(items)) {
        items.forEach(item => {
          $select.append(new Option(item, item));
        });
      }
      $select.select2({ placeholder: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å..." });
    }

    function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }
      const formData = new FormData();
      formData.append("file", file); // FIXED key name here

      $.ajax({
        url: backendURL + "/upload_raw_data",
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        xhr: function () {
          const xhr = new window.XMLHttpRequest();
          xhr.upload.addEventListener("progress", function (evt) {
            if (evt.lengthComputable) {
              const percent = (evt.loaded / evt.total) * 100;
              $("#uploadProgress").css("width", percent + "%");
            }
          });
          return xhr;
        },
        success: function (res) {
          if (!res || !res.months) {
            alert("Response ‡∏ú‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");
            return;
          }
          populate("months", res.months);
          populate("category2", res.category2Options);
          populate("category3", res.category3Options);
          populate("status", res.statusOptions);
          populate("processStatus", res.processStatusOptions);
          $("#filters").show();
        },
        error: function (xhr) {
          alert("Upload ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + xhr.responseText);
        }
      });
    }

    function generateOutput2() {
      const body = {
        months: $("#months").val(),
        category2: $("#category2").val(),
        category3: $("#category3").val(),
        status: $("#status").val(),
        processStatus: $("#processStatus").val(),
        top5: $("input[name='top5Option']:checked").val()
      };

      fetch(backendURL + "/generate_output2", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      })
      .then(response => {
        if (!response.ok) throw new Error("‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Output2 ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Output2.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
      })
      .catch(error => alert(error.message));
    }
  </script>
</body>
</html>
